<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storytellers — Luxury Travel Sweden</title>
    <meta name="description" content="Meet the curators, guides, and local experts who bring Sweden's hidden stories to life. Each storyteller opens doors to authentic experiences beyond the guidebook.">

    <link rel="stylesheet" href="/styles.css">
    <style>
        /* Storytellers Page Styles */
        .storytellers-hero {
            padding: clamp(9rem, 14vw, 11rem) 2rem 4rem;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            text-align: center;
        }

        [data-theme="light"] .storytellers-hero {
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            color: #1a1a1a;
        }

        .storytellers-hero h1 {
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 300;
            margin-bottom: 1rem;
        }

        .storytellers-hero p {
            font-size: 1.25rem;
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
        }

        .storytellers-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 4rem 2rem;
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f0f0f0;
            border-top-color: #1a1a1a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h2 {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1a1a1a;
        }

        [data-theme="dark"] .empty-state h2 {
            color: #ffffff;
        }

        .empty-state p {
            color: #666;
            font-size: 1.125rem;
        }

        [data-theme="dark"] .empty-state p {
            color: #aaa;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .storytellers-hero {
                padding: 6rem 1.5rem 3rem;
            }
        }
    </style>

    <!-- Component Loader - Load shared header/footer -->
    <script src="/component-loader.js"></script>
</head>
<body>
    <!-- Header loaded from /components/header.html -->
    <div id="header-placeholder"></div>

    <main class="site-main">
        <!-- Hero Section -->
        <section class="storytellers-hero">
            <h1>Our Storytellers</h1>
            <p>Meet the curators, guides, and local experts who bring Sweden's hidden stories to life. Each one opens doors to authentic experiences beyond the guidebook.</p>
        </section>

        <!-- Storytellers Container -->
        <div class="storytellers-container">
            <!-- Loading State -->
            <div class="loading-state" id="loadingState">
                <div class="loading-spinner"></div>
                <p>Loading storytellers...</p>
            </div>

            <!-- Empty State -->
            <div class="empty-state hidden" id="emptyState">
                <div class="empty-state-icon">✦</div>
                <h2>No Storytellers Yet</h2>
                <p>Check back soon to meet our curators and local experts.</p>
            </div>

            <!-- Storytellers Grid -->
            <div class="pillars-grid hidden" id="storytellersGrid">
                <!-- Storyteller cards will be inserted here by JavaScript -->
            </div>

            <!-- Back to Home Link -->
            <div class="back-link-container">
                <a href="/" class="back-link">Back to Home</a>
            </div>
        </div>
    </main>

    <!-- Footer loaded from /components/footer.html -->
    <div id="footer-placeholder"></div>

    <!-- Chat Overlay -->
    <div class="chat-overlay" id="chatOverlay">
        <div class="chat-container">
            <button class="close-chat" id="closeChat">×</button>
            <div class="chat-header">
                <h2 class="chat-title">LIV</h2>
                <p class="chat-subtitle">Your Luxury Itinerary Visionary</p>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message ai">
                    <p>Welcome. I'm LIV — Luxury Itinerary Visionary. I'm here to craft extraordinary Swedish journeys tailored to your desires.</p>
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="Share your travel desires...">
                <button class="send-button" id="sendButton">Send</button>
            </div>
        </div>
    </div>

    <!-- Pillar Modal for Storyteller Details -->
    <div class="pillar-modal-overlay" id="pillarModal">
        <div class="pillar-modal-content">
            <button class="pillar-modal-close" aria-label="Close modal">&times;</button>
            <img src="" alt="" class="pillar-modal-image" id="modal-image">
            <div class="pillar-modal-body">
                <h2 class="pillar-modal-title" id="modal-title">Storyteller Name</h2>
                <div class="pillar-modal-description" id="modal-description">
                    <p>Description will appear here...</p>
                </div>
                <button type="button" class="pillar-modal-cta" id="modal-cta" data-open-liv data-liv-context-type="storyteller" data-liv-context-name="Storyteller">
                    Design with LIV
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/supabase-client.js"></script>
    <script defer src="/liv-ai.js?v=8"></script>
    <script src="/scripts.js?v=1761950330"></script>
    <script>
        // Storytellers Page State
        let allStorytellers = [];

        // Initialize
        async function init() {
            try {
                await loadAllStorytellers();
            } catch (error) {
                console.error('Error initializing storytellers page:', error);
                showEmpty();
            }
        }

        // Load all storytellers from Supabase
        async function loadAllStorytellers() {
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const storytellersGrid = document.getElementById('storytellersGrid');

            try {
                // Check if Supabase is available
                if (!window.Supabase || !window.Supabase.db) {
                    throw new Error('Supabase not configured');
                }

                // Fetch all published storytellers
                allStorytellers = await window.Supabase.db.getStories(true);

                loadingState.classList.add('hidden');

                if (allStorytellers.length === 0) {
                    emptyState.classList.remove('hidden');
                    storytellersGrid.classList.add('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    storytellersGrid.classList.remove('hidden');
                    renderStorytellers();
                }
            } catch (error) {
                console.error('Error loading storytellers:', error);
                loadingState.classList.add('hidden');
                emptyState.classList.remove('hidden');
                storytellersGrid.classList.add('hidden');
            }
        }

        // Render storytellers
        function renderStorytellers() {
            const storytellersGrid = document.getElementById('storytellersGrid');

            // Sort by display_order and published date
            const sortedStorytellers = allStorytellers.sort((a, b) => {
                // First sort by display_order if both have it
                if (a.display_order !== null && b.display_order !== null) {
                    return a.display_order - b.display_order;
                }
                // If only one has display_order, prioritize it
                if (a.display_order !== null) return -1;
                if (b.display_order !== null) return 1;
                // Otherwise sort by date (newest first)
                return new Date(b.published_at) - new Date(a.published_at);
            });

            // Generate slug from title
            function generateSlug(title) {
                return title.toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/(^-|-$)/g, '');
            }

            // Store storyteller data globally for modal access
            window.storytellerData = {};

            // Generate HTML
            storytellersGrid.innerHTML = sortedStorytellers.map(story => {
                const slug = generateSlug(story.title);
                const imageUrl = story.hero_image_url || 'https://via.placeholder.com/400x500';

                // Store in global object for modal
                window.storytellerData[slug] = {
                    title: story.title,
                    image: story.hero_image_url || 'https://via.placeholder.com/400x500',
                    content: story.content || `<p>${escapeHtml(story.excerpt || '')}</p>`,
                    cta: "Design with LIV",
                    contextType: "storyteller",
                    contextName: story.title
                };

                return `
                    <article class="pillar-card" data-storyteller="${escapeHtml(slug)}">
                        <div class="pillar-media" aria-hidden="true">
                            <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(story.title)}" loading="lazy">
                        </div>
                        <div class="pillar-body">
                            <div class="pillar-copy">
                                <h3>${escapeHtml(story.title)}</h3>
                                <p>${escapeHtml(story.excerpt || '')}</p>
                                <button type="button" class="read-more-btn">read more</button>
                                <button type="button" class="pillar-cta" data-open-liv data-liv-context-type="storyteller" data-liv-context-name="${escapeHtml(story.title)}">Design with LIV</button>
                            </div>
                        </div>
                    </article>
                `;
            }).join('');

            // Reinitialize Lucide icons
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }

            // Initialize modal functionality for read-more buttons
            initializeStorytellerModals();
        }

        // Initialize modal functionality
        function initializeStorytellerModals() {
            const pillarModal = document.getElementById('pillarModal');
            const modalTitle = document.getElementById('modal-title');
            const modalImage = document.getElementById('modal-image');
            const modalDescription = document.getElementById('modal-description');
            const modalCta = document.getElementById('modal-cta');
            const modalClose = document.querySelector('.pillar-modal-close');

            if (!pillarModal) return;

            // Attach click handlers to read-more buttons
            document.querySelectorAll('.read-more-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const pillarCard = this.closest('.pillar-card');
                    const slug = pillarCard?.dataset.storyteller;
                    const data = window.storytellerData[slug];

                    if (data && modalTitle && modalImage && modalDescription && modalCta) {
                        modalTitle.textContent = data.title;
                        modalImage.src = data.image;
                        modalImage.alt = data.title;
                        modalDescription.innerHTML = data.content;
                        modalCta.textContent = data.cta;

                        // Set context attributes for LIV personalization
                        if (data.contextType && data.contextName) {
                            modalCta.setAttribute('data-liv-context-type', data.contextType);
                            modalCta.setAttribute('data-liv-context-name', data.contextName);
                        }

                        pillarModal.style.display = 'flex';
                        document.body.style.overflow = 'hidden';
                    }
                });
            });

            // Close modal handlers
            function closeModal() {
                if (pillarModal) {
                    pillarModal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            }

            if (modalClose) {
                modalClose.addEventListener('click', closeModal);
            }

            if (pillarModal) {
                pillarModal.addEventListener('click', function(e) {
                    if (e.target === pillarModal) {
                        closeModal();
                    }
                });
            }

            // Close on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && pillarModal && pillarModal.style.display === 'flex') {
                    closeModal();
                }
            });
        }

        // Helper functions
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showEmpty() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('storytellersGrid').classList.add('hidden');
        }

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            init();
        });
    </script>

    <!-- Menu Initialization - Simple, reliable menu system -->
    <script defer src="/menu-init.js"></script>
</body>
</html>

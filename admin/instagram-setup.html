<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="../">
  <title>Instagram Setup - Luxury Travel Sweden CMS</title>
  <link rel="stylesheet" href="admin/admin.css">

    <!-- Component Loader -->
    <script src="admin/admin-component-loader.js?v=3"></script>
</head>
<body>
  <div class="admin-container">
    <!-- Sidebar Navigation - Loaded from component -->

    <div id="sidebar-placeholder"></div>

    <main class="main-content">
      <header class="content-header">
        <div class="header-left">
          <h1>Instagram Feed Setup</h1>
          <p class="subtitle">Configure Instagram integration for homepage display</p>
        </div>
        <div class="header-right">
          <a href="/" class="btn-secondary" target="_blank">
            <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
              <path d="M10 3L3 8V17H7V12H13V17H17V8L10 3Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
            </svg>
            View Site
          </a>
        </div>
      </header>

      <div id="alertContainer"></div>

      <!-- Simple Token Entry -->
      <div class="content-card">
        <h3>Connect Your Instagram Account</h3>
        <p style="margin-bottom: 1.5rem; color: rgba(255,255,255,0.6);">
          Paste your Instagram access token below to display your photos on the homepage.
        </p>

        <form id="tokenForm">
          <div class="form-group">
            <label class="form-label" for="manualToken">Instagram Access Token</label>
            <textarea
              id="manualToken"
              class="form-input"
              placeholder="Paste your Instagram access token here..."
              rows="4"
              style="font-family: monospace; font-size: 0.875rem;"
            ></textarea>
            <p style="margin-top: 0.5rem; font-size: 0.875rem; color: rgba(255,255,255,0.5);">
              Don't have a token? <a href="https://spotlightwp.com/access-token-generator/" target="_blank" style="color: var(--admin-accent);">Get one here in 1 minute</a>
            </p>
          </div>

          <button type="submit" class="btn btn-success" id="saveTokenBtn">
            <span id="saveTokenBtnText">Save Token</span>
          </button>
          <button type="button" class="btn btn-secondary" id="clearTokenBtn" style="margin-left: 1rem;">
            Clear Token (Use Free Feed)
          </button>
        </form>
      </div>

      <!-- Current Status -->
      <div class="content-card" style="margin-top: 2rem;">
        <h3>Connection Status</h3>
        <div id="currentStatus" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
          <div class="loading" style="width: 30px; height: 30px;"></div>
          <span>Loading status...</span>
        </div>

        <div id="tokenActions" style="margin-top: 1.5rem; display: none;">
          <button onclick="refreshToken()" class="btn btn-secondary">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
              <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0115.5-8.5l4 4M22 12.5a10 10 0 01-15.5 8.5l-4-4"/>
            </svg>
            Refresh Token (Extend Expiration)
          </button>
          <button onclick="testConnection()" class="btn btn-secondary" style="margin-left: 1rem;">
            Test Connection
          </button>
        </div>

        <div id="statusMessage" style="margin-top: 1.5rem; padding: 1rem; border-radius: 8px; display: none;"></div>
      </div>

      <!-- Setup Instructions -->
      <div class="content-card" style="margin-top: 2rem;">
        <h3>How to Get Your Instagram Token</h3>

        <div style="padding: 1rem; background: rgba(33,150,243,0.1); border-left: 3px solid #2196f3; border-radius: 4px; margin-bottom: 1.5rem;">
          <strong>Note:</strong> Without a custom token, your site uses a free Instagram feed powered by StormLikes. Add your own token for a custom-designed feed.
        </div>

        <h4 style="margin-top: 1.5rem; margin-bottom: 0.75rem;">Quick Setup (1 minute)</h4>
        <ol style="line-height: 1.8; color: rgba(255,255,255,0.8); margin-left: 1.5rem;">
          <li>Visit <a href="https://spotlightwp.com/access-token-generator/" target="_blank" style="color: var(--admin-accent);">Spotlight Token Generator</a></li>
          <li>Click "Generate Token" and log in to Instagram</li>
          <li>Copy the token it gives you</li>
          <li>Paste it in the field above and click "Save Token"</li>
          <li>Done! Your custom feed will appear on the homepage</li>
        </ol>

        <h4 style="margin-top: 1.5rem; margin-bottom: 0.75rem;">Requirements</h4>
        <ul style="line-height: 1.8; color: rgba(255,255,255,0.8); margin-left: 1.5rem;">
          <li>Your Instagram account must be set to <strong>Business</strong> or <strong>Creator</strong> mode</li>
          <li>To switch: Open Instagram app → Settings → Account → Switch to Professional Account</li>
        </ul>

        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(76,175,80,0.1); border-left: 3px solid #4caf50; border-radius: 4px; color: rgba(255,255,255,0.8);">
          <strong>Token Lifespan:</strong> Tokens last 60 days. When it expires, just get a new one using the same process - takes 1 minute!
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js?v=2"></script>
  <script src="admin/auth.js"></script>

  <script>
    async function loadSettings() {
      try {
        const { data, error } = await window.Supabase.client
          .from('instagram_settings')
          .select('manual_token, access_token, token_expires_at, last_fetched_at, user_id')
          .single();

        if (error) throw error;

        // Populate manual token field if exists
        if (data.manual_token) {
          document.getElementById('manualToken').value = data.manual_token;
        }

        // Update connection status
        const activeToken = data.manual_token || data.access_token;
        if (activeToken) {
          const expiresAt = data.token_expires_at ? new Date(data.token_expires_at) : null;
          const now = new Date();
          const daysUntilExpiry = expiresAt ? Math.floor((expiresAt - now) / (1000 * 60 * 60 * 24)) : null;

          let statusType = 'success';
          let statusMessage = data.manual_token ? 'Connected (Custom Token)' : 'Connected (OAuth)';

          if (daysUntilExpiry !== null) {
            if (daysUntilExpiry < 0) {
              statusType = 'error';
              statusMessage = 'Token Expired';
            } else if (daysUntilExpiry < 7) {
              statusType = 'warning';
              statusMessage = `${data.manual_token ? 'Custom Token' : 'OAuth'} (Expires in ${daysUntilExpiry} days)`;
            } else {
              statusMessage = `${data.manual_token ? 'Custom Token' : 'OAuth'} (Expires in ${daysUntilExpiry} days)`;
            }
          }

          updateStatus(statusMessage, statusType, data.last_fetched_at, expiresAt);
          document.getElementById('tokenActions').style.display = 'block';
        } else {
          updateStatus('Using free StormLikes feed', 'warning');
        }
      } catch (error) {
        console.error('Error loading settings:', error);
        updateStatus('Error loading status', 'error');
      }
    }

    function updateStatus(message, type, lastFetched = null, expiresAt = null) {
      const statusDiv = document.getElementById('currentStatus');
      const colors = {
        success: '#4caf50',
        warning: '#ff9800',
        error: '#f44336'
      };

      let html = `
        <div style="width: 12px; height: 12px; border-radius: 50%; background: ${colors[type]};"></div>
        <span>${message}</span>
      `;

      if (expiresAt) {
        const date = new Date(expiresAt);
        html += `<span style="margin-left: 1rem; color: rgba(255,255,255,0.5); font-size: 0.875rem;">
          Expires: ${date.toLocaleDateString()}
        </span>`;
      }

      if (lastFetched) {
        const date = new Date(lastFetched);
        html += `<span style="margin-left: 1rem; color: rgba(255,255,255,0.5); font-size: 0.875rem;">
          Last synced: ${date.toLocaleString()}
        </span>`;
      }

      statusDiv.innerHTML = html;
    }

    async function saveToken(event) {
      event.preventDefault();

      const saveBtn = document.getElementById('saveTokenBtn');
      const saveBtnText = document.getElementById('saveTokenBtnText');
      const token = document.getElementById('manualToken').value.trim();

      if (!token) {
        showAlert('Please enter an Instagram access token', 'error');
        return;
      }

      try {
        saveBtn.disabled = true;
        saveBtnText.textContent = 'Saving...';

        const { error } = await window.Supabase.client
          .from('instagram_settings')
          .update({
            manual_token: token,
            updated_at: new Date().toISOString()
          })
          .eq('id', '00000000-0000-0000-0000-000000000001');

        if (error) throw error;

        showAlert('Instagram token saved successfully! Your photos will now appear on the homepage.', 'success');
        await loadSettings();
      } catch (error) {
        console.error('Error saving token:', error);
        showAlert('Failed to save token: ' + error.message, 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtnText.textContent = 'Save Token';
      }
    }

    async function clearToken() {
      if (!confirm('Clear your custom Instagram token and use the free StormLikes feed instead?')) {
        return;
      }

      try {
        const { error } = await window.Supabase.client
          .from('instagram_settings')
          .update({
            manual_token: null,
            updated_at: new Date().toISOString()
          })
          .eq('id', '00000000-0000-0000-0000-000000000001');

        if (error) throw error;

        document.getElementById('manualToken').value = '';
        showAlert('Token cleared. Now using free StormLikes feed.', 'success');
        await loadSettings();
      } catch (error) {
        console.error('Error clearing token:', error);
        showAlert('Failed to clear token: ' + error.message, 'error');
      }
    }

    async function refreshToken() {
      const statusMessage = document.getElementById('statusMessage');
      statusMessage.style.display = 'block';
      statusMessage.style.background = 'rgba(255,255,255,0.05)';
      statusMessage.innerHTML = '<div class="loading" style="width: 24px; height: 24px; display: inline-block; vertical-align: middle;"></div><span style="margin-left: 1rem;">Refreshing token...</span>';

      try {
        const response = await fetch('https://fjnfsabvuiyzuzfhxzcc.supabase.co/functions/v1/instagram-oauth?action=refresh');
        const data = await response.json();

        if (data.error) {
          statusMessage.style.background = 'rgba(244,67,54,0.1)';
          statusMessage.style.borderLeft = '3px solid #f44336';
          statusMessage.innerHTML = `<strong>Refresh Failed</strong><br>${data.error}`;
        } else {
          statusMessage.style.background = 'rgba(76,175,80,0.1)';
          statusMessage.style.borderLeft = '3px solid #4caf50';
          statusMessage.innerHTML = `<strong>Success!</strong><br>Token refreshed. Valid for ${data.expires_in_days} more days.`;
          await loadSettings();
        }
      } catch (error) {
        statusMessage.style.background = 'rgba(244,67,54,0.1)';
        statusMessage.style.borderLeft = '3px solid #f44336';
        statusMessage.innerHTML = `<strong>Error</strong><br>${error.message}`;
      }
    }

    async function testConnection() {
      const statusMessage = document.getElementById('statusMessage');
      statusMessage.style.display = 'block';
      statusMessage.style.background = 'rgba(255,255,255,0.05)';
      statusMessage.innerHTML = '<div class="loading" style="width: 24px; height: 24px; display: inline-block; vertical-align: middle;"></div><span style="margin-left: 1rem;">Testing connection...</span>';

      try {
        const response = await fetch('https://fjnfsabvuiyzuzfhxzcc.supabase.co/functions/v1/fetch-instagram');
        const data = await response.json();

        if (data.error) {
          statusMessage.style.background = 'rgba(244,67,54,0.1)';
          statusMessage.style.borderLeft = '3px solid #f44336';
          statusMessage.innerHTML = `<strong>Connection Failed</strong><br>${data.error || data.details}`;
        } else if (data.posts && data.posts.length > 0) {
          statusMessage.style.background = 'rgba(76,175,80,0.1)';
          statusMessage.style.borderLeft = '3px solid #4caf50';
          statusMessage.innerHTML = `<strong>Success!</strong><br>Fetched ${data.posts.length} posts from Instagram.`;
        } else {
          statusMessage.style.background = 'rgba(255,152,0,0.1)';
          statusMessage.style.borderLeft = '3px solid #ff9800';
          statusMessage.innerHTML = '<strong>Connected</strong><br>No posts found. Make sure your Instagram Business account has posts.';
        }
      } catch (error) {
        statusMessage.style.background = 'rgba(244,67,54,0.1)';
        statusMessage.style.borderLeft = '3px solid #f44336';
        statusMessage.innerHTML = `<strong>Error</strong><br>${error.message}`;
      }
    }

    function showAlert(message, type = 'info') {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.innerHTML = `
        <span>${escapeHtml(message)}</span>
        <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; color: inherit; cursor: pointer; font-size: 1.25rem; line-height: 1;">&times;</button>
      `;

      container.appendChild(alert);

      setTimeout(() => {
        alert.style.opacity = '0';
        setTimeout(() => alert.remove(), 300);
      }, 5000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    document.getElementById('tokenForm').addEventListener('submit', saveToken);
    document.getElementById('clearTokenBtn').addEventListener('click', clearToken);

    (async function() {
      const user = await window.AuthManager.requireAuth();
      if (user) {
        await window.AuthManager.updateUserInfoUI();
        await loadSettings();
      }
    })();
  </script>
</body>
</html>

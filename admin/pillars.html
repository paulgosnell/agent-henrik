<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="../">
  <title>Pillars Management - Luxury Travel Sweden CMS</title>

  <!-- Quill.js CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <!-- Admin CSS -->
  <link rel="stylesheet" href="admin/admin.css">

    <!-- Component Loader -->
    <script src="admin/admin-component-loader.js?v=3"></script>
  <style>
    .icon-preview {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.5rem;
      padding: 0.75rem;
      background: var(--admin-surface-raised);
      border: 1px solid var(--admin-border);
      border-radius: var(--admin-radius);
    }
    .icon-preview svg {
      width: 24px;
      height: 24px;
      stroke: var(--admin-text-primary);
    }
    .icon-preview-text {
      color: var(--admin-text-secondary);
      font-size: 0.875rem;
    }
    .pillar-icon {
      width: 40px;
      height: 40px;
      background: var(--admin-surface-raised);
      border-radius: var(--admin-radius);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 0.75rem;
      flex-shrink: 0;
    }
    .pillar-icon svg {
      width: 24px;
      height: 24px;
      stroke: currentColor;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <!-- Sidebar Navigation - Loaded from component -->

    <div id="sidebar-placeholder"></div>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Header -->
      <header class="content-header">
        <div class="header-left">
          <h1>Pillars</h1>
          <p class="subtitle">Manage Experiences and Corporate & Incentives content</p>
        </div>
        <div class="header-right">
          <a href="/" class="btn-secondary" target="_blank">
            <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
              <path d="M10 3L3 8V17H7V12H13V17H17V8L10 3Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
            </svg>
            View Site
          </a>
        </div>
      </header>

      <!-- Alert Container -->
      <div id="alertContainer"></div>

      <!-- Toolbar -->
      <div class="admin-toolbar">
        <div class="admin-toolbar-left">
          <div class="search-box">
            <input
              type="text"
              id="searchInput"
              placeholder="Search pillars..."
              aria-label="Search pillars"
            >
          </div>
          <div class="filter-group">
            <label class="filter-label" for="sectionFilter">Section:</label>
            <select id="sectionFilter">
              <option value="">All</option>
              <option value="experiences">Experiences</option>
              <option value="corporate">Corporate</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label" for="statusFilter">Status:</label>
            <select id="statusFilter">
              <option value="all">All</option>
              <option value="published">Published</option>
              <option value="draft">Draft</option>
            </select>
          </div>
        </div>
        <div class="admin-toolbar-right">
          <button class="btn btn-primary" onclick="openAddPillarModal()">
            <span>+</span>
            Add New Pillar
          </button>
        </div>
      </div>

      <!-- Pillars Container -->
      <div id="pillarsContainer">
        <!-- Loading state -->
        <div id="loadingState" class="empty-state">
          <div class="empty-state-icon">
            <div class="loading" style="width: 60px; height: 60px; border-width: 6px;"></div>
          </div>
          <h3>Loading pillars...</h3>
        </div>

        <!-- Empty state -->
        <div id="emptyState" class="empty-state hidden">
          <div class="empty-state-icon">üìã</div>
          <h3>No pillars found</h3>
          <p>Get started by creating your first pillar</p>
          <button class="btn btn-primary" onclick="openAddPillarModal()">
            <span>+</span>
            Add Pillar
          </button>
        </div>

        <!-- Table -->
        <div id="tableContainer" class="destinations-table hidden">
          <table>
            <thead>
              <tr>
                <th>Pillar</th>
                <th>Section</th>
                <th>Display Order</th>
                <th>Published</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="pillarsTableBody">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Add/Edit Pillar Modal -->
  <div id="pillarModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add New Pillar</h2>
        <button class="modal-close" onclick="closePillarModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="pillarForm">
          <input type="hidden" id="pillarId">

          <div class="form-grid">
            <!-- Title -->
            <div class="form-group full-width">
              <label class="form-label required" for="title">Title</label>
              <input
                type="text"
                id="title"
                class="form-input"
                placeholder="e.g., Arctic Adventures"
                required
              >
            </div>

            <!-- Slug -->
            <div class="form-group full-width">
              <label class="form-label required" for="slug">Slug</label>
              <input
                type="text"
                id="slug"
                class="form-input"
                placeholder="e.g., arctic-adventures"
                required
              >
              <span class="form-hint">Auto-generated from title, can be customized</span>
            </div>

            <!-- Excerpt -->
            <div class="form-group full-width">
              <label class="form-label required" for="excerpt">Excerpt</label>
              <textarea
                id="excerpt"
                class="form-textarea"
                placeholder="Brief summary of the pillar (max 300 characters)"
                maxlength="300"
                required
                style="min-height: 80px;"
              ></textarea>
              <span class="form-hint"><span id="excerptCount">0</span>/300 characters</span>
            </div>

            <!-- Content (Rich Text Editor) -->
            <div class="form-group full-width">
              <label class="form-label required">Content</label>
              <div id="editor" style="min-height: 300px; background: var(--admin-surface-raised); border: 1px solid var(--admin-border); border-radius: var(--admin-radius);"></div>
              <input type="hidden" id="content">
            </div>

            <!-- Hero Image Selector -->
            <div class="form-group full-width">
              <label class="form-label required">Hero Image</label>

              <!-- Image Selection Tabs -->
              <div class="image-selector-tabs">
                <button type="button" class="image-tab active" data-tab="upload" onclick="switchImageTab('upload')">
                  üì§ Upload
                </button>
                <button type="button" class="image-tab" data-tab="url" onclick="switchImageTab('url')">
                  üîó URL
                </button>
                <button type="button" class="image-tab" data-tab="library" onclick="switchImageTab('library')">
                  üñºÔ∏è Media Library
                </button>
              </div>

              <!-- Upload Tab -->
              <div id="uploadTab" class="image-tab-content active">
                <div class="image-upload-area" id="imageUploadArea">
                  <input
                    type="file"
                    id="heroImageUpload"
                    accept="image/*"
                    style="display: none;"
                    onchange="handleImageSelect(event)"
                  >
                  <div id="uploadPlaceholder" class="upload-placeholder">
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">Click to upload or drag and drop</div>
                    <div class="upload-hint">PNG, JPG, WebP up to 10MB</div>
                  </div>
                  <div id="imagePreviewContainer" class="image-preview-container hidden">
                    <img id="heroImagePreview" class="image-preview" src="" alt="Preview">
                    <button type="button" class="image-remove" onclick="removeImage()">Remove Image</button>
                  </div>
                </div>
                <div id="uploadProgress" class="upload-progress">
                  <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                  </div>
                  <div id="progressText" class="progress-text">Uploading...</div>
                </div>
              </div>

              <!-- URL Tab -->
              <div id="urlTab" class="image-tab-content">
                <input
                  type="text"
                  id="heroImageUrlInput"
                  class="form-input"
                  placeholder="https://example.com/image.jpg"
                  oninput="handleUrlInput(event)"
                >
                <span class="form-hint">Enter the full URL to the image</span>
                <div id="urlImagePreview" class="image-preview-container hidden" style="margin-top: 1rem;">
                  <img id="urlPreviewImg" class="image-preview" src="" alt="URL Preview">
                  <button type="button" class="image-remove" onclick="removeUrlImage()">Remove Image</button>
                </div>
              </div>

              <!-- Media Library Tab -->
              <div id="libraryTab" class="image-tab-content">
                <div id="mediaLibraryGrid" class="media-library-grid">
                  <div class="loading-media">
                    <div class="loading"></div>
                    <p>Loading media library...</p>
                  </div>
                </div>
              </div>

              <input type="hidden" id="heroImageUrl">
            </div>

            <!-- Icon Name -->
            <div class="form-group full-width">
              <label class="form-label required" for="iconName">Icon Name</label>
              <input
                type="text"
                id="iconName"
                class="form-input"
                placeholder="e.g., leaf, mountain, compass"
                required
              >
              <span class="form-hint">Lucide icon name (see <a href="https://lucide.dev/icons/" target="_blank">lucide.dev</a>)</span>
              <div id="iconPreview" class="icon-preview hidden">
                <div id="iconPreviewSvg"></div>
                <span class="icon-preview-text">Icon preview</span>
              </div>
            </div>

            <!-- Section -->
            <div class="form-group">
              <label class="form-label required" for="section">Section</label>
              <select id="section" class="form-input" required>
                <option value="">Select section...</option>
                <option value="experiences">Experiences</option>
                <option value="corporate">Corporate</option>
              </select>
            </div>

            <!-- Display Order -->
            <div class="form-group">
              <label class="form-label required" for="displayOrder">Display Order</label>
              <input
                type="number"
                id="displayOrder"
                class="form-input"
                placeholder="1"
                min="0"
                value="0"
                required
              >
              <span class="form-hint">Lower numbers appear first</span>
            </div>

            <!-- CTA Text -->
            <div class="form-group">
              <label class="form-label" for="ctaText">CTA Text</label>
              <input
                type="text"
                id="ctaText"
                class="form-input"
                placeholder="Design with LIV"
                value="Design with LIV"
              >
            </div>

            <!-- LIV Context Type -->
            <div class="form-group">
              <label class="form-label" for="livContextType">LIV Context Type</label>
              <input
                type="text"
                id="livContextType"
                class="form-input"
                placeholder="experience"
              >
              <span class="form-hint">Default: "experience" or "corporate"</span>
            </div>

            <!-- LIV Context Name -->
            <div class="form-group full-width">
              <label class="form-label" for="livContextName">LIV Context Name</label>
              <input
                type="text"
                id="livContextName"
                class="form-input"
                placeholder="e.g., Arctic Adventures in Swedish Lapland"
              >
              <span class="form-hint">Context for LIV AI assistant</span>
            </div>

            <!-- LIV Context Instructions -->
            <div class="form-group full-width">
              <label for="livContext">
                LIV Context Instructions (Optional)
                <span style="color: var(--admin-text-secondary); font-size: 13px; margin-left: 8px;">
                  ‚ìò Specific guidance for LIV when users click this experience
                </span>
              </label>
              <textarea
                id="livContext"
                class="form-textarea"
                rows="8"
                placeholder="Example for Nature & Wellness:
‚Ä¢ Experience types: Both single-day and multi-day options available
‚Ä¢ Duration options: 1 day (spa day), 3 days (wellness retreat), 7 days (full program)
‚Ä¢ ALWAYS ask: 'Are you interested in a single-day experience or a longer retreat?'
‚Ä¢ Partner venues: Yasuragi Hasseludden, Run√∂ G√•rd
‚Ä¢ Price ranges: Single day ‚Ç¨200-400, 3-day ‚Ç¨800-1,500, 7-day ‚Ç¨2,500-5,000
‚Ä¢ Best seasons: Year-round, but summer most popular"
                data-field="liv_context"
              ></textarea>
              <small style="color: var(--admin-text-secondary); display: block; margin-top: 4px;">
                <strong>Important:</strong> If this experience can be both single-day OR multi-day, state that clearly and instruct LIV to ASK the user about duration preference first.
              </small>
              <div id="livContextCopyBtn"></div>
            </div>

            <!-- Greeting Override -->
            <div class="form-group full-width">
              <label class="form-label" for="greetingOverride">
                Custom Greeting (Optional)
                <span style="color: var(--admin-text-secondary); font-size: 13px; margin-left: 8px;">
                  ‚ìò Override the default greeting when users click this experience
                </span>
              </label>
              <textarea
                id="greetingOverride"
                class="form-textarea"
                rows="3"
                placeholder="Example: I love curating nature-based wellness journeys. What aspect resonates with you ‚Äî forest bathing, cold therapy, or mindful movement?"
                data-field="greeting_override"
              ></textarea>
              <small style="color: var(--admin-text-secondary); display: block; margin-top: 4px;">
                If set, this replaces the default greeting. Keep it warm and engaging (1-2 sentences max).
              </small>
              <div id="greetingOverrideCopyBtn"></div>
            </div>

            <!-- Published Checkbox -->
            <div class="form-group full-width">
              <label class="form-label">
                <input type="checkbox" id="published" style="margin-right: 0.5rem;">
                Published
              </label>
              <span class="form-hint">Check to make this pillar visible on the site</span>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closePillarModal()">
          Cancel
        </button>
        <button type="submit" class="btn btn-success" onclick="savePillar(event)" id="saveBtn">
          <span id="saveBtnText">Save Pillar</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content confirm-dialog">
      <div class="modal-body">
        <div class="confirm-icon danger">‚ö†Ô∏è</div>
        <h3 class="confirm-title">Delete Pillar?</h3>
        <p class="confirm-message">
          Are you sure you want to delete "<span id="deletePillarName"></span>"?
          This action cannot be undone.
        </p>
        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
          <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
          <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Quill.js -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js"></script>

  <!-- Supabase Client -->
  <script src="supabase-client.js?v=2"></script>

  <!-- ChatGPT Helper for Copy Buttons -->
  <script src="chatgpt-helper.js"></script>

  <!-- Main Application Script -->
  <script>
    // ==========================================
    // STATE
    // ==========================================
    let pillars = [];
    let filteredPillars = [];
    let quillEditor = null;
    let currentPillar = null;
    let deletePillarId = null;
    let currentImageFile = null;
    let existingImageUrl = null;
    let mediaLibraryImages = [];
    let selectedLibraryImage = null;
    let currentImageSource = 'upload'; // 'upload', 'url', or 'library'

    // ==========================================
    // INITIALIZATION
    // ==========================================
    async function init() {
      try {
        // Check authentication
        const user = await window.Supabase.auth.getUser();
        if (!user) {
          window.location.href = 'login.html';
          return;
        }

        // Update user info
        const userEmailEl = document.getElementById('userEmail');
        if (userEmailEl && user.email) {
          userEmailEl.textContent = user.email;
        }

        // Check if Supabase is configured
        if (!window.Supabase) {
          showAlert('error', 'Supabase is not configured. Please update your credentials in supabase-client.js');
          return;
        }

        // Load data
        await loadPillars();

        // Setup event listeners
        setupEventListeners();

        console.log('Pillars admin panel initialized successfully');
      } catch (error) {
        console.error('Initialization error:', error);
        showAlert('error', 'Failed to initialize admin panel: ' + error.message);
      }
    }

    // ==========================================
    // DATA LOADING
    // ==========================================
    async function loadPillars() {
      try {
        showLoading();
        pillars = await window.Supabase.db.getPillars(null, false); // Include drafts

        filteredPillars = [...pillars];
        renderPillars();
      } catch (error) {
        console.error('Error loading pillars:', error);
        showAlert('error', 'Failed to load pillars: ' + error.message);
        showEmpty();
      }
    }

    // ==========================================
    // RENDERING
    // ==========================================
    function renderPillars() {
      const tbody = document.getElementById('pillarsTableBody');
      const tableContainer = document.getElementById('tableContainer');
      const emptyState = document.getElementById('emptyState');
      const loadingState = document.getElementById('loadingState');

      loadingState.classList.add('hidden');

      if (filteredPillars.length === 0) {
        tableContainer.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');
      tableContainer.classList.remove('hidden');

      tbody.innerHTML = filteredPillars.map(pillar => {
        const iconHtml = pillar.icon_name ? `<div class="pillar-icon">${getIconSvg(pillar.icon_name)}</div>` : '';
        return `
        <tr onclick="editPillar('${pillar.id}')">
          <td>
            <div class="destination-preview">
              ${iconHtml}
              <div class="destination-info">
                <h3>${escapeHtml(pillar.title)}</h3>
                <p>${escapeHtml(pillar.excerpt.substring(0, 50))}${pillar.excerpt.length > 50 ? '...' : ''}</p>
              </div>
            </div>
          </td>
          <td>
            <span class="badge ${pillar.section === 'experiences' ? 'badge-category' : 'badge-published'}">
              ${pillar.section === 'experiences' ? 'Experiences' : 'Corporate'}
            </span>
          </td>
          <td>
            <span class="badge badge-category">${pillar.display_order}</span>
          </td>
          <td>
            <span class="badge ${pillar.published ? 'badge-published' : 'badge-draft'}">
              ${pillar.published ? 'Published' : 'Draft'}
            </span>
          </td>
          <td>
            <div class="action-buttons" onclick="event.stopPropagation()">
              <button
                class="action-btn action-btn-edit"
                onclick="editPillar('${pillar.id}')"
                title="Edit"
              >‚úèÔ∏è</button>
              <button
                class="action-btn action-btn-delete"
                onclick="deletePillar('${pillar.id}', '${escapeHtml(pillar.title)}')"
                title="Delete"
              >üóëÔ∏è</button>
            </div>
          </td>
        </tr>
      `}).join('');

      // Initialize Lucide icons after rendering
      if (window.lucide && typeof window.lucide.createIcons === 'function') {
        window.lucide.createIcons();
      }
    }

    // ==========================================
    // FILTERING & SEARCH
    // ==========================================
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const sectionFilter = document.getElementById('sectionFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;

      filteredPillars = pillars.filter(pillar => {
        // Search filter
        const matchesSearch = !searchTerm ||
          pillar.title.toLowerCase().includes(searchTerm) ||
          pillar.excerpt.toLowerCase().includes(searchTerm) ||
          (pillar.content && pillar.content.toLowerCase().includes(searchTerm));

        // Section filter
        const matchesSection = !sectionFilter || pillar.section === sectionFilter;

        // Status filter
        const matchesStatus = statusFilter === 'all' ||
          (statusFilter === 'published' && pillar.published) ||
          (statusFilter === 'draft' && !pillar.published);

        return matchesSearch && matchesSection && matchesStatus;
      });

      renderPillars();
    }

    // ==========================================
    // MODAL MANAGEMENT
    // ==========================================
    function openAddPillarModal() {
      currentPillar = null;
      document.getElementById('modalTitle').textContent = 'Add New Pillar';
      document.getElementById('pillarForm').reset();
      document.getElementById('pillarId').value = '';
      document.getElementById('displayOrder').value = '0';
      document.getElementById('ctaText').value = 'Design with LIV';
      document.getElementById('published').checked = false;

      // Reset all image tabs
      resetImageSelector();

      // Hide icon preview
      document.getElementById('iconPreview').classList.add('hidden');

      // Clear editor
      if (quillEditor) {
        quillEditor.root.innerHTML = '';
      }

      // Reset character count
      updateCharacterCount('excerpt', 'excerptCount');

      // Open modal
      document.getElementById('pillarModal').classList.add('active');

      // Initialize Quill editor
      setTimeout(() => {
        initQuillEditor();
      }, 100);
    }

    function resetImageSelector() {
      // Reset state
      currentImageFile = null;
      existingImageUrl = null;
      selectedLibraryImage = null;
      currentImageSource = 'upload';
      document.getElementById('heroImageUrl').value = '';

      // Reset upload tab
      document.getElementById('heroImageUpload').value = '';
      document.getElementById('uploadPlaceholder').classList.remove('hidden');
      document.getElementById('imagePreviewContainer').classList.add('hidden');
      document.getElementById('imageUploadArea').classList.remove('has-image');

      // Reset URL tab
      document.getElementById('heroImageUrlInput').value = '';
      document.getElementById('urlImagePreview').classList.add('hidden');

      // Reset library tab selection
      document.querySelectorAll('.media-library-item').forEach(item => {
        item.classList.remove('selected');
        const badge = item.querySelector('.media-library-item-selected-badge');
        if (badge) badge.remove();
      });

      // Switch to upload tab
      switchImageTab('upload');
    }

    function closePillarModal() {
      document.getElementById('pillarModal').classList.remove('active');

      // Destroy Quill editor
      if (quillEditor) {
        quillEditor = null;
      }
    }

    function editPillar(id) {
      currentPillar = pillars.find(p => p.id === id);
      if (!currentPillar) return;

      document.getElementById('modalTitle').textContent = 'Edit Pillar';
      document.getElementById('pillarId').value = currentPillar.id;
      document.getElementById('title').value = currentPillar.title;
      document.getElementById('slug').value = currentPillar.slug;
      document.getElementById('excerpt').value = currentPillar.excerpt || '';
      document.getElementById('iconName').value = currentPillar.icon_name || '';
      document.getElementById('section').value = currentPillar.section;
      document.getElementById('displayOrder').value = currentPillar.display_order || 0;
      document.getElementById('ctaText').value = currentPillar.cta_text || 'Design with LIV';
      document.getElementById('livContextType').value = currentPillar.liv_context_type || '';
      document.getElementById('livContextName').value = currentPillar.liv_context_name || '';
      document.getElementById('livContext').value = currentPillar.liv_context || '';
      document.getElementById('greetingOverride').value = currentPillar.greeting_override || '';
      document.getElementById('published').checked = currentPillar.published || false;

      // Set image - show in upload tab as preview
      if (currentPillar.hero_image_url) {
        existingImageUrl = currentPillar.hero_image_url;
        currentImageSource = 'existing';
        document.getElementById('heroImageUrl').value = currentPillar.hero_image_url;

        // Show preview in upload tab
        document.getElementById('heroImagePreview').src = currentPillar.hero_image_url;
        document.getElementById('uploadPlaceholder').classList.add('hidden');
        document.getElementById('imagePreviewContainer').classList.remove('hidden');
        document.getElementById('imageUploadArea').classList.add('has-image');
      }

      // Show icon preview
      if (currentPillar.icon_name) {
        updateIconPreview(currentPillar.icon_name);
      }

      // Update character count
      updateCharacterCount('excerpt', 'excerptCount');

      // Open modal
      document.getElementById('pillarModal').classList.add('active');

      // Initialize Quill editor with content
      setTimeout(() => {
        initQuillEditor(currentPillar.content);
      }, 100);

      // Initialize ChatGPT Copy buttons
      if (window.ChatGPTHelper) {
        const contextBtn = window.ChatGPTHelper.createCopyButton('pillar', currentPillar.title, currentPillar.description, 'context');
        document.getElementById('livContextCopyBtn').innerHTML = '';
        document.getElementById('livContextCopyBtn').appendChild(contextBtn);

        const greetingBtn = window.ChatGPTHelper.createCopyButton('pillar', currentPillar.title, '', 'greeting');
        document.getElementById('greetingOverrideCopyBtn').innerHTML = '';
        document.getElementById('greetingOverrideCopyBtn').appendChild(greetingBtn);
      }
    }

    function deletePillar(id, title) {
      deletePillarId = id;
      document.getElementById('deletePillarName').textContent = title;
      document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('active');
      deletePillarId = null;
    }

    async function confirmDelete() {
      if (!deletePillarId) return;

      try {
        await window.Supabase.db.deletePillar(deletePillarId);
        showAlert('success', 'Pillar deleted successfully');
        closeDeleteModal();
        await loadPillars();
      } catch (error) {
        console.error('Error deleting pillar:', error);
        showAlert('error', 'Failed to delete pillar: ' + error.message);
      }
    }

    // ==========================================
    // QUILL EDITOR
    // ==========================================
    function initQuillEditor(content = '') {
      if (quillEditor) return;

      quillEditor = new Quill('#editor', {
        theme: 'snow',
        modules: {
          toolbar: [
            [{ 'header': [2, 3, false] }],
            ['bold', 'italic', 'underline'],
            ['link', 'image'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['blockquote', 'code-block'],
            ['clean']
          ]
        },
        placeholder: 'Write your pillar content here...'
      });

      // Set initial content
      if (content) {
        quillEditor.root.innerHTML = content;
      }
    }

    // ==========================================
    // IMAGE UPLOAD
    // ==========================================
    function setupImageUpload() {
      const uploadArea = document.getElementById('imageUploadArea');
      const fileInput = document.getElementById('heroImageUpload');

      // Click to upload
      uploadArea.addEventListener('click', (e) => {
        if (e.target.classList.contains('image-remove')) return;
        fileInput.click();
      });

      // Drag and drop
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-over');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleImageFile(files[0]);
        }
      });
    }

    function handleImageSelect(event) {
      const file = event.target.files[0];
      if (file) {
        handleImageFile(file);
      }
    }

    function handleImageFile(file) {
      // Validate file type
      if (!file.type.startsWith('image/')) {
        showAlert('error', 'Please select an image file');
        return;
      }

      // Validate file size (10MB)
      if (file.size > 10 * 1024 * 1024) {
        showAlert('error', 'Image size must be less than 10MB');
        return;
      }

      currentImageFile = file;

      // Show preview
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('heroImagePreview').src = e.target.result;
        document.getElementById('uploadPlaceholder').classList.add('hidden');
        document.getElementById('imagePreviewContainer').classList.remove('hidden');
        document.getElementById('imageUploadArea').classList.add('has-image');
      };
      reader.readAsDataURL(file);
    }

    function removeImage() {
      currentImageFile = null;
      existingImageUrl = null;
      document.getElementById('heroImageUrl').value = '';
      document.getElementById('heroImageUpload').value = '';
      document.getElementById('uploadPlaceholder').classList.remove('hidden');
      document.getElementById('imagePreviewContainer').classList.add('hidden');
      document.getElementById('imageUploadArea').classList.remove('has-image');
    }

    async function uploadImage() {
      if (!currentImageFile) {
        return existingImageUrl || null;
      }

      const progressDiv = document.getElementById('uploadProgress');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');

      try {
        progressDiv.classList.add('active');
        progressFill.style.width = '0%';
        progressText.textContent = 'Uploading...';

        // Simulate progress
        const progressInterval = setInterval(() => {
          const currentWidth = parseInt(progressFill.style.width) || 0;
          if (currentWidth < 90) {
            progressFill.style.width = (currentWidth + 10) + '%';
          }
        }, 200);

        const result = await window.Supabase.storage.uploadFile(currentImageFile);

        clearInterval(progressInterval);
        progressFill.style.width = '100%';
        progressText.textContent = 'Upload complete!';

        setTimeout(() => {
          progressDiv.classList.remove('active');
        }, 1000);

        return result.url;
      } catch (error) {
        progressDiv.classList.remove('active');
        throw error;
      }
    }

    // ==========================================
    // TAB SWITCHING
    // ==========================================
    function switchImageTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.image-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`.image-tab[data-tab="${tabName}"]`).classList.add('active');

      // Update tab content
      document.querySelectorAll('.image-tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${tabName}Tab`).classList.add('active');

      // Load media library if switching to that tab
      if (tabName === 'library' && mediaLibraryImages.length === 0) {
        loadMediaLibrary();
      }
    }

    // ==========================================
    // URL IMAGE HANDLING
    // ==========================================
    function handleUrlInput(event) {
      const url = event.target.value.trim();
      const preview = document.getElementById('urlImagePreview');
      const img = document.getElementById('urlPreviewImg');

      if (url) {
        img.src = url;
        img.onerror = () => {
          preview.classList.add('hidden');
          showAlert('error', 'Failed to load image from URL');
        };
        img.onload = () => {
          preview.classList.remove('hidden');
          currentImageSource = 'url';
          existingImageUrl = url;
          document.getElementById('heroImageUrl').value = url;
        };
      } else {
        preview.classList.add('hidden');
      }
    }

    function removeUrlImage() {
      document.getElementById('heroImageUrlInput').value = '';
      document.getElementById('urlImagePreview').classList.add('hidden');
      document.getElementById('heroImageUrl').value = '';
      existingImageUrl = null;
    }

    // ==========================================
    // MEDIA LIBRARY
    // ==========================================
    async function loadMediaLibrary() {
      const grid = document.getElementById('mediaLibraryGrid');

      try {
        grid.innerHTML = `
          <div class="loading-media">
            <div class="loading"></div>
            <p>Loading media library...</p>
          </div>
        `;

        // Load media files from Supabase
        mediaLibraryImages = await window.Supabase.storage.getMediaFiles();

        if (mediaLibraryImages.length === 0) {
          grid.innerHTML = `
            <div class="empty-media">
              <p>No images in media library</p>
              <p style="font-size: 0.875rem; margin-top: 0.5rem;">
                Upload images from the <a href="media.html" target="_blank" style="color: var(--admin-primary);">Media Library page</a>
              </p>
            </div>
          `;
          return;
        }

        // Render media grid
        grid.innerHTML = mediaLibraryImages.map(media => `
          <div
            class="media-library-item ${selectedLibraryImage === media.id ? 'selected' : ''}"
            onclick="selectLibraryImage('${media.id}', '${media.url}')"
            title="${media.filename}"
          >
            <img src="${media.url}" alt="${media.alt_text || media.filename}" loading="lazy">
            ${selectedLibraryImage === media.id ? '<div class="media-library-item-selected-badge">‚úì</div>' : ''}
          </div>
        `).join('');

      } catch (error) {
        console.error('Error loading media library:', error);
        grid.innerHTML = `
          <div class="empty-media">
            <p>Failed to load media library</p>
            <p style="font-size: 0.875rem; margin-top: 0.5rem; color: var(--admin-danger);">
              ${error.message}
            </p>
          </div>
        `;
      }
    }

    function selectLibraryImage(mediaId, mediaUrl) {
      selectedLibraryImage = mediaId;
      currentImageSource = 'library';
      existingImageUrl = mediaUrl;
      document.getElementById('heroImageUrl').value = mediaUrl;

      // Update selection UI
      document.querySelectorAll('.media-library-item').forEach(item => {
        item.classList.remove('selected');
        const badge = item.querySelector('.media-library-item-selected-badge');
        if (badge) badge.remove();
      });

      const selectedItem = document.querySelector(`.media-library-item[onclick*="${mediaId}"]`);
      if (selectedItem) {
        selectedItem.classList.add('selected');
        selectedItem.insertAdjacentHTML('beforeend', '<div class="media-library-item-selected-badge">‚úì</div>');
      }

      showAlert('success', 'Image selected from library');
    }

    // ==========================================
    // SAVE PILLAR
    // ==========================================
    async function savePillar(event) {
      event.preventDefault();

      const saveBtn = document.getElementById('saveBtn');
      const saveBtnText = document.getElementById('saveBtnText');
      const originalText = saveBtnText.textContent;

      try {
        // Disable button
        saveBtn.disabled = true;
        saveBtnText.innerHTML = '<div class="loading"></div> Saving...';

        // Get form data
        const id = document.getElementById('pillarId').value;
        const title = document.getElementById('title').value.trim();
        const slug = document.getElementById('slug').value.trim();
        const excerpt = document.getElementById('excerpt').value.trim();
        const iconName = document.getElementById('iconName').value.trim();
        const section = document.getElementById('section').value;
        const displayOrder = parseInt(document.getElementById('displayOrder').value) || 0;
        const ctaText = document.getElementById('ctaText').value.trim() || 'Design with LIV';
        const livContextType = document.getElementById('livContextType').value.trim() || (section === 'corporate' ? 'corporate' : 'experience');
        const livContextName = document.getElementById('livContextName').value.trim();
        const livContext = document.getElementById('livContext').value.trim();
        const greetingOverride = document.getElementById('greetingOverride').value.trim();
        const published = document.getElementById('published').checked;

        // Get content from Quill
        const content = quillEditor ? quillEditor.root.innerHTML : '';

        // Validate
        if (!title || !slug || !excerpt || !iconName || !section) {
          showAlert('error', 'Please fill in all required fields');
          return;
        }

        if (!content || content === '<p><br></p>') {
          showAlert('error', 'Please add content to your pillar');
          return;
        }

        // Determine hero image URL based on source
        let heroImageUrl = null;

        if (currentImageFile) {
          // Upload new file
          heroImageUrl = await uploadImage();
        } else if (existingImageUrl) {
          // Use existing URL (from URL tab, library, or existing pillar)
          heroImageUrl = existingImageUrl;
        }

        // Validate hero image
        if (!heroImageUrl) {
          showAlert('error', 'Please select a hero image (upload, enter URL, or choose from library)');
          return;
        }

        // Prepare data
        const pillarData = {
          title,
          slug,
          excerpt,
          content,
          hero_image_url: heroImageUrl,
          icon_name: iconName,
          section,
          display_order: displayOrder,
          cta_text: ctaText,
          liv_context_type: livContextType,
          liv_context_name: livContextName,
          liv_context: livContext,
          greeting_override: greetingOverride || null,
          published
        };

        // Save to database
        if (id) {
          await window.Supabase.db.updatePillar(id, pillarData);
          showAlert('success', 'Pillar updated successfully');
        } else {
          await window.Supabase.db.createPillar(pillarData);
          showAlert('success', 'Pillar created successfully');
        }

        // Close modal and refresh
        closePillarModal();
        await loadPillars();

      } catch (error) {
        console.error('Error saving pillar:', error);
        showAlert('error', 'Failed to save pillar: ' + error.message);
      } finally {
        saveBtn.disabled = false;
        saveBtnText.textContent = originalText;
      }
    }

    // ==========================================
    // ICON PREVIEW
    // ==========================================
    function updateIconPreview(iconName) {
      const preview = document.getElementById('iconPreview');
      const previewSvg = document.getElementById('iconPreviewSvg');

      if (iconName) {
        const svg = getIconSvg(iconName);
        if (svg) {
          previewSvg.innerHTML = svg;
          preview.classList.remove('hidden');
          // Initialize Lucide icons for the preview
          if (window.lucide && typeof window.lucide.createIcons === 'function') {
            window.lucide.createIcons();
          }
        } else {
          preview.classList.add('hidden');
        }
      } else {
        preview.classList.add('hidden');
      }
    }

    function getIconSvg(iconName) {
      if (!iconName) {
        return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
      }

      // Return a data-lucide attribute wrapper so lucide.createIcons() can render it
      // This matches the pattern used in the main site
      return `<i data-lucide="${iconName}" style="width: 24px; height: 24px;"></i>`;
    }

    // ==========================================
    // UTILITY FUNCTIONS
    // ==========================================
    function generateSlug(title) {
      return title
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    function updateCharacterCount(inputId, countId) {
      const input = document.getElementById(inputId);
      const counter = document.getElementById(countId);
      if (input && counter) {
        counter.textContent = input.value.length;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showAlert(type, message) {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.innerHTML = `
        <span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ'}</span>
        <span>${message}</span>
      `;

      container.appendChild(alert);

      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    function showLoading() {
      document.getElementById('loadingState').classList.remove('hidden');
      document.getElementById('tableContainer').classList.add('hidden');
      document.getElementById('emptyState').classList.add('hidden');
    }

    function showEmpty() {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('tableContainer').classList.add('hidden');
      document.getElementById('emptyState').classList.remove('hidden');
    }

    // ==========================================
    // EVENT LISTENERS
    // ==========================================
    function setupEventListeners() {
      // Logout
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          await window.Supabase.auth.signOut();
          window.location.href = 'login.html';
        });
      }

      // Search and filters
      document.getElementById('searchInput').addEventListener('input', applyFilters);
      document.getElementById('sectionFilter').addEventListener('change', applyFilters);
      document.getElementById('statusFilter').addEventListener('change', applyFilters);

      // Auto-generate slug from title
      document.getElementById('title').addEventListener('input', (e) => {
        if (!document.getElementById('pillarId').value) {
          document.getElementById('slug').value = generateSlug(e.target.value);
        }
      });

      // Character counter
      document.getElementById('excerpt').addEventListener('input', () => {
        updateCharacterCount('excerpt', 'excerptCount');
      });

      // Icon preview
      document.getElementById('iconName').addEventListener('input', (e) => {
        updateIconPreview(e.target.value);
      });

      // Auto-set LIV context type based on section
      document.getElementById('section').addEventListener('change', (e) => {
        const contextTypeInput = document.getElementById('livContextType');
        if (!contextTypeInput.value) {
          contextTypeInput.value = e.target.value === 'corporate' ? 'corporate' : 'experience';
        }
      });

      // Image upload
      setupImageUpload();

      // Close modal on outside click
      document.getElementById('pillarModal').addEventListener('click', (e) => {
        if (e.target.id === 'pillarModal') {
          closePillarModal();
        }
      });

      document.getElementById('deleteModal').addEventListener('click', (e) => {
        if (e.target.id === 'deleteModal') {
          closeDeleteModal();
        }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closePillarModal();
          closeDeleteModal();
        }
      });
    }

    // ==========================================
    // START APPLICATION
    // ==========================================
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="../">
  <title>Stories Management - Luxury Travel Sweden CMS</title>

  <!-- Quill.js CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <!-- Leaflet CSS for map picker -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>

  <!-- Admin CSS -->
  <link rel="stylesheet" href="admin/admin.css">

    <!-- Component Loader -->
    <script src="admin/admin-component-loader.js?v=3"></script>
</head>
<body>
  <div class="admin-container">
    <!-- Sidebar Navigation - Loaded from component -->

    <div id="sidebar-placeholder"></div>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Header -->
      <header class="content-header">
        <div class="header-left">
          <h1>Stories</h1>
          <p class="subtitle">Manage client testimonials and stories</p>
        </div>
        <div class="header-right">
          <a href="/" class="btn-secondary" target="_blank">
            <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
              <path d="M10 3L3 8V17H7V12H13V17H17V8L10 3Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
            </svg>
            View Site
          </a>
        </div>
      </header>

      <!-- Alert Container -->
      <div id="alertContainer"></div>

      <!-- Toolbar -->
      <div class="admin-toolbar">
        <div class="admin-toolbar-left">
          <div class="search-box">
            <input
              type="text"
              id="searchInput"
              placeholder="Search stories..."
              aria-label="Search stories"
            >
          </div>
          <div class="filter-group">
            <label class="filter-label" for="statusFilter">Status:</label>
            <select id="statusFilter">
              <option value="all">All</option>
              <option value="published">Published</option>
              <option value="draft">Draft</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label" for="categoryFilter">Category:</label>
            <select id="categoryFilter">
              <option value="">All Categories</option>
            </select>
          </div>
        </div>
        <div class="admin-toolbar-right">
          <button class="btn btn-primary" onclick="openAddStoryModal()">
            <span>+</span>
            Add New Story
          </button>
        </div>
      </div>

      <!-- Stories Container -->
      <div id="storiesContainer">
        <!-- Loading state -->
        <div id="loadingState" class="empty-state">
          <div class="empty-state-icon">
            <div class="loading" style="width: 60px; height: 60px; border-width: 6px;"></div>
          </div>
          <h3>Loading stories...</h3>
        </div>

        <!-- Empty state -->
        <div id="emptyState" class="empty-state hidden">
          <div class="empty-state-icon">üìñ</div>
          <h3>No stories found</h3>
          <p>Get started by creating your first story</p>
          <button class="btn btn-primary" onclick="openAddStoryModal()">
            <span>+</span>
            Add Story
          </button>
        </div>

        <!-- Table -->
        <div id="tableContainer" class="destinations-table hidden">
          <table>
            <thead>
              <tr>
                <th>Story</th>
                <th>Category</th>
                <th>Display Order</th>
                <th>Published</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="storiesTableBody">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Add/Edit Story Modal -->
  <div id="storyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add New Story</h2>
        <button class="modal-close" onclick="closeStoryModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="storyForm">
          <input type="hidden" id="storyId">

          <div class="form-grid">
            <!-- Title -->
            <div class="form-group full-width">
              <label class="form-label required" for="title">Title</label>
              <input
                type="text"
                id="title"
                class="form-input"
                placeholder="e.g., An Unforgettable Journey Through Swedish Lapland"
                required
              >
            </div>

            <!-- Slug -->
            <div class="form-group full-width">
              <label class="form-label required" for="slug">Slug</label>
              <input
                type="text"
                id="slug"
                class="form-input"
                placeholder="e.g., unforgettable-journey-swedish-lapland"
                required
              >
              <span class="form-hint">Auto-generated from title, can be customized</span>
            </div>

            <!-- Excerpt -->
            <div class="form-group full-width">
              <label class="form-label required" for="excerpt">Excerpt</label>
              <textarea
                id="excerpt"
                class="form-textarea"
                placeholder="Brief summary of the story (max 200 characters)"
                maxlength="200"
                required
                style="min-height: 80px;"
              ></textarea>
              <span class="form-hint"><span id="excerptCount">0</span>/200 characters</span>
            </div>

            <!-- Content (Rich Text Editor) -->
            <div class="form-group full-width">
              <label class="form-label required">Content</label>
              <div id="editor" style="min-height: 300px; background: var(--admin-surface-raised); border: 1px solid var(--admin-border); border-radius: var(--admin-radius);"></div>
              <input type="hidden" id="content">
            </div>

            <!-- Hero Image Upload -->
            <div class="form-group full-width">
              <label class="form-label" for="imageUpload">Hero Image</label>
              <div class="image-upload-area" id="imageUploadArea">
                <input
                  type="file"
                  id="imageUpload"
                  accept="image/*"
                  style="display: none;"
                  onchange="handleImageSelect(event)"
                >
                <div id="uploadPlaceholder" class="upload-placeholder">
                  <div class="upload-icon">üì∑</div>
                  <div class="upload-text">Click to upload or drag and drop</div>
                  <div class="upload-hint">PNG, JPG, WebP up to 10MB</div>
                </div>
                <div id="imagePreviewContainer" class="image-preview-container hidden">
                  <img id="imagePreview" class="image-preview" src="" alt="Preview">
                  <button type="button" class="image-remove" onclick="removeImage()">Remove Image</button>
                </div>
              </div>
              <div id="uploadProgress" class="upload-progress">
                <div class="progress-bar">
                  <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
                <div id="progressText" class="progress-text">Uploading...</div>
              </div>
              <input type="hidden" id="heroImageUrl">
            </div>

            <!-- Category -->
            <div class="form-group">
              <label class="form-label" for="category">Category</label>
              <select
                id="category"
                class="form-input"
                onchange="toggleStorytellerFields()"
              >
                <option value="">Select category...</option>
                <option value="Storyteller">Storyteller</option>
                <option value="Experience">Experience</option>
                <option value="Culture">Culture</option>
                <option value="Travel Tips">Travel Tips</option>
              </select>
              <span class="form-hint">Select "Storyteller" for creative professionals</span>
            </div>

            <!-- Storyteller-specific fields (hidden by default) -->
            <div id="storytellerFields" class="form-group full-width" style="display: none;">
              <div style="border: 2px solid #eab308; border-radius: 8px; padding: 1.5rem; background: rgba(234, 179, 8, 0.05);">
                <h3 style="margin: 0 0 1rem 0; color: #eab308; font-size: 1.1rem;">‚ú® Storyteller Information</h3>

                <!-- Bio -->
                <div class="form-group full-width" style="margin-bottom: 1.5rem;">
                  <label class="form-label" for="bio">Bio/Background</label>
                  <textarea
                    id="bio"
                    class="form-textarea"
                    placeholder="Brief professional background (will default to excerpt if not provided)"
                    style="min-height: 100px;"
                  ></textarea>
                  <span class="form-hint">Optional - defaults to excerpt</span>
                </div>

                <!-- Specialty Topics -->
                <div class="form-group full-width" style="margin-bottom: 1.5rem;">
                  <label class="form-label">Specialty Topics</label>
                  <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" name="specialtyTopic" value="film"> Film
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" name="specialtyTopic" value="music"> Music
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" name="specialtyTopic" value="performance"> Performance
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" name="specialtyTopic" value="fashion"> Fashion
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" name="specialtyTopic" value="design"> Design
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" name="specialtyTopic" value="art"> Visual Art
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" name="specialtyTopic" value="writing"> Writing
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" name="specialtyTopic" value="photography"> Photography
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" name="specialtyTopic" value="digital_media"> Digital Media
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" name="specialtyTopic" value="technology"> Technology
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" name="specialtyTopic" value="wellness"> Wellness
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" name="specialtyTopic" value="culinary"> Culinary
                    </label>
                  </div>
                  <span class="form-hint">Select all that apply</span>
                </div>

                <!-- Activity Types -->
                <div class="form-group full-width">
                  <label class="form-label">Available Activities</label>
                  <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" name="activityType" value="meet_and_greet"> Meet & Greet
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" name="activityType" value="workshop"> Workshop
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" name="activityType" value="creative_activity"> Creative Activity
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" name="activityType" value="consultation"> Consultation
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" name="activityType" value="performance"> Performance
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" name="activityType" value="tour"> Tour
                    </label>
                  </div>
                  <span class="form-hint">Select activities this storyteller can offer</span>
                </div>

                <!-- LIV Context -->
                <div class="form-group full-width" style="margin-top: 1.5rem;">
                  <label for="livContext">
                    LIV Context Instructions (Optional)
                    <span style="color: var(--admin-text-secondary); font-size: 13px; margin-left: 8px;">
                      ‚ìò Specific guidance for LIV about this storyteller
                    </span>
                  </label>
                  <textarea
                    id="livContext"
                    class="form-textarea"
                    rows="6"
                    placeholder="Example:
‚Ä¢ Session types: 2-hour meet & greet, half-day workshop, full-day collaboration
‚Ä¢ Availability: Year-round, book 2-4 weeks in advance
‚Ä¢ Group sizes: 1-12 people (intimate sessions preferred)
‚Ä¢ Languages: Swedish, English
‚Ä¢ Price ranges: Meet & greet ‚Ç¨500-800, Workshop ‚Ç¨1,500-2,500, Full-day ‚Ç¨3,000-5,000
‚Ä¢ Best for: Corporate creative sessions, private artistic experiences"
                    data-field="liv_context"
                  ></textarea>
                  <small style="color: var(--admin-text-secondary); display: block; margin-top: 4px;">
                    This context helps LIV give accurate information about session types, pricing, and logistics. The Topics and Activity Types fields above are already shared with LIV automatically.
                  </small>
                  <div id="livContextCopyBtn"></div>
                </div>

                <!-- Greeting Override -->
                <div class="form-group full-width">
                  <label class="form-label" for="greetingOverride">
                    Custom Greeting (Optional)
                    <span style="color: var(--admin-text-secondary); font-size: 13px; margin-left: 8px;">
                      ‚ìò Override the default greeting when users click this storyteller
                    </span>
                  </label>
                  <textarea
                    id="greetingOverride"
                    class="form-textarea"
                    rows="3"
                    placeholder="Example: I'm excited to connect you with storytellers who bring Sweden's creative soul to life. What type of experience are you drawn to?"
                    data-field="greeting_override"
                  ></textarea>
                  <small style="color: var(--admin-text-secondary); display: block; margin-top: 4px;">
                    If set, this replaces the default greeting (1-2 sentences max).
                  </small>
                  <div id="greetingOverrideCopyBtn"></div>
                </div>

                <!-- Map Location Section -->
                <div class="form-group full-width" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid rgba(234, 179, 8, 0.2);">
                  <h4 style="margin: 0 0 1rem 0; color: #eab308; font-size: 1rem;">üìç Map Location</h4>

                  <!-- Show on Map Checkbox -->
                  <div class="form-group full-width" style="margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" id="showOnMap" name="showOnMap" style="width: auto;">
                      <span style="font-weight: 600;">Show this storyteller on the map</span>
                    </label>
                    <span class="form-hint" style="margin-left: 1.5rem;">Enable to display as a map marker on the homepage</span>
                  </div>

                  <!-- Interactive Map Picker -->
                  <div class="form-group full-width" style="margin-bottom: 1rem;">
                    <label class="form-label">Click on map to set location</label>
                    <div id="storytellerMapPicker" style="height: 400px; width: 100%; border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0;"></div>
                    <span class="form-hint">Click anywhere on the map or drag the marker to set coordinates</span>
                  </div>

                  <!-- Latitude/Longitude -->
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                      <label class="form-label" for="latitude">Latitude</label>
                      <input
                        type="number"
                        id="latitude"
                        class="form-input"
                        placeholder="e.g., 59.3293"
                        step="0.000001"
                        min="-90"
                        max="90"
                      >
                      <span class="form-hint">Decimal degrees (-90 to 90)</span>
                    </div>
                    <div class="form-group">
                      <label class="form-label" for="longitude">Longitude</label>
                      <input
                        type="number"
                        id="longitude"
                        class="form-input"
                        placeholder="e.g., 18.0686"
                        step="0.000001"
                        min="-180"
                        max="180"
                      >
                      <span class="form-hint">Decimal degrees (-180 to 180)</span>
                    </div>
                  </div>

                  <span class="form-hint" style="margin-top: 0.5rem; display: block;">
                    üí° Tip: You can also type coordinates directly in the fields above
                  </span>
                </div>
              </div>
            </div>

            <!-- Display Order -->
            <div class="form-group">
              <label class="form-label required" for="displayOrder">Display Order</label>
              <input
                type="number"
                id="displayOrder"
                class="form-input"
                placeholder="1"
                min="0"
                value="0"
                required
              >
              <span class="form-hint">Lower numbers appear first</span>
            </div>

            <!-- Author -->
            <div class="form-group">
              <label class="form-label required" for="author">Author</label>
              <input
                type="text"
                id="author"
                class="form-input"
                placeholder="e.g., LIV Team"
                value="LIV Team"
                required
              >
            </div>

            <!-- Published Date/Time -->
            <div class="form-group">
              <label class="form-label" for="publishedAt">Published Date/Time</label>
              <input
                type="datetime-local"
                id="publishedAt"
                class="form-input"
              >
              <span class="form-hint">Leave empty to save as draft</span>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeStoryModal()">
          Cancel
        </button>
        <button type="button" class="btn btn-secondary" onclick="saveStory(event, true)" id="saveDraftBtn">
          Save as Draft
        </button>
        <button type="submit" class="btn btn-success" onclick="saveStory(event, false)" id="saveBtn">
          <span id="saveBtnText">Publish Story</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content confirm-dialog">
      <div class="modal-body">
        <div class="confirm-icon danger">‚ö†Ô∏è</div>
        <h3 class="confirm-title">Delete Story?</h3>
        <p class="confirm-message">
          Are you sure you want to delete "<span id="deleteStoryName"></span>"?
          This action cannot be undone.
        </p>
        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
          <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
          <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Quill.js -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <!-- Leaflet.js for map picker -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

  <!-- Map Picker Component -->
  <script src="components/map-picker.js"></script>

  <!-- Supabase Client -->
  <script src="supabase-client.js?v=2"></script>

  <!-- ChatGPT Helper -->
  <script src="chatgpt-helper.js"></script>

  <!-- Main Application Script -->
  <script>
    // ==========================================
    // STATE
    // ==========================================
    let stories = [];
    let filteredStories = [];
    let quillEditor = null;
    let currentStory = null;
    let deleteStoryId = null;
    let currentImageFile = null;
    let existingImageUrl = null;
    let categories = new Set();
    let storytellerMapPicker = null;

    // ==========================================
    // INITIALIZATION
    // ==========================================
    async function init() {
      try {
        // Check authentication
        const user = await window.Supabase.auth.getUser();
        if (!user) {
          window.location.href = 'login.html';
          return;
        }

        // Update user info
        const userEmailEl = document.getElementById('userEmail');
        if (userEmailEl && user.email) {
          userEmailEl.textContent = user.email;
        }

        // Check if Supabase is configured
        if (!window.Supabase) {
          showAlert('error', 'Supabase is not configured. Please update your credentials in supabase-client.js');
          return;
        }

        // Load data
        await loadStories();

        // Setup event listeners
        setupEventListeners();

        console.log('Stories admin panel initialized successfully');
      } catch (error) {
        console.error('Initialization error:', error);
        showAlert('error', 'Failed to initialize admin panel: ' + error.message);
      }
    }

    // ==========================================
    // DATA LOADING
    // ==========================================
    async function loadStories() {
      try {
        showLoading();
        stories = await window.Supabase.db.getStories(false); // Include drafts

        // Extract unique categories
        categories.clear();
        stories.forEach(story => {
          if (story.category) {
            categories.add(story.category);
          }
        });

        // Populate category filter
        const categoryFilter = document.getElementById('categoryFilter');
        categoryFilter.innerHTML = '<option value="">All Categories</option>';
        Array.from(categories).sort().forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          categoryFilter.appendChild(option);
        });

        filteredStories = [...stories];
        renderStories();
      } catch (error) {
        console.error('Error loading stories:', error);
        showAlert('error', 'Failed to load stories: ' + error.message);
        showEmpty();
      }
    }

    // ==========================================
    // RENDERING
    // ==========================================
    function renderStories() {
      const tbody = document.getElementById('storiesTableBody');
      const tableContainer = document.getElementById('tableContainer');
      const emptyState = document.getElementById('emptyState');
      const loadingState = document.getElementById('loadingState');

      loadingState.classList.add('hidden');

      if (filteredStories.length === 0) {
        tableContainer.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');
      tableContainer.classList.remove('hidden');

      tbody.innerHTML = filteredStories.map(story => `
        <tr onclick="editStory('${story.id}')">
          <td>
            <div class="destination-preview">
              <img
                src="${story.hero_image_url || 'https://via.placeholder.com/60'}"
                alt="${story.title}"
                class="destination-image"
              >
              <div class="destination-info">
                <h3>${escapeHtml(story.title)}</h3>
                <p>${escapeHtml(story.excerpt.substring(0, 50))}${story.excerpt.length > 50 ? '...' : ''}</p>
              </div>
            </div>
          </td>
          <td>
            ${story.category ? `<span class="badge ${story.category === 'Storyteller' ? 'badge-published' : 'badge-category'}" style="${story.category === 'Storyteller' ? 'background: #eab308; color: #000;' : ''}">${escapeHtml(story.category)}</span>` : '<span class="text-muted">‚Äî</span>'}
          </td>
          <td>
            <span class="badge badge-category">${story.display_order}</span>
          </td>
          <td>
            <span class="badge ${story.published_at ? 'badge-published' : 'badge-draft'}">
              ${story.published_at ? formatDate(story.published_at) : 'Draft'}
            </span>
          </td>
          <td>
            <div class="action-buttons" onclick="event.stopPropagation()">
              <button
                class="action-btn action-btn-edit"
                onclick="editStory('${story.id}')"
                title="Edit"
              >‚úèÔ∏è</button>
              <button
                class="action-btn action-btn-delete"
                onclick="deleteStory('${story.id}', '${escapeHtml(story.title)}')"
                title="Delete"
              >üóëÔ∏è</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // ==========================================
    // FILTERING & SEARCH
    // ==========================================
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const categoryFilter = document.getElementById('categoryFilter').value;

      filteredStories = stories.filter(story => {
        // Search filter
        const matchesSearch = !searchTerm ||
          story.title.toLowerCase().includes(searchTerm) ||
          story.excerpt.toLowerCase().includes(searchTerm) ||
          (story.content && story.content.toLowerCase().includes(searchTerm));

        // Status filter
        const matchesStatus = statusFilter === 'all' ||
          (statusFilter === 'published' && story.published_at) ||
          (statusFilter === 'draft' && !story.published_at);

        // Category filter
        const matchesCategory = !categoryFilter || story.category === categoryFilter;

        return matchesSearch && matchesStatus && matchesCategory;
      });

      renderStories();
    }

    // ==========================================
    // MODAL MANAGEMENT
    // ==========================================
    function openAddStoryModal() {
      currentStory = null;
      document.getElementById('modalTitle').textContent = 'Add New Story';
      document.getElementById('storyForm').reset();
      document.getElementById('storyId').value = '';
      document.getElementById('author').value = 'LIV Team';
      document.getElementById('displayOrder').value = '0';

      // Reset image
      currentImageFile = null;
      existingImageUrl = null;
      document.getElementById('heroImageUrl').value = '';
      document.getElementById('uploadPlaceholder').classList.remove('hidden');
      document.getElementById('imagePreviewContainer').classList.add('hidden');
      document.getElementById('imageUploadArea').classList.remove('has-image');

      // Reset storyteller fields
      document.getElementById('bio').value = '';
      document.getElementById('livContext').value = '';
      document.getElementById('greetingOverride').value = '';
      document.querySelectorAll('input[name="specialtyTopic"]').forEach(checkbox => {
        checkbox.checked = false;
      });
      document.querySelectorAll('input[name="activityType"]').forEach(checkbox => {
        checkbox.checked = false;
      });
      toggleStorytellerFields();

      // Clear editor
      if (quillEditor) {
        quillEditor.root.innerHTML = '';
      }

      // Reset character count
      updateCharacterCount('excerpt', 'excerptCount');

      // Open modal
      document.getElementById('storyModal').classList.add('active');

      // Initialize Quill editor
      setTimeout(() => {
        initQuillEditor();
      }, 100);
    }

    function closeStoryModal() {
      document.getElementById('storyModal').classList.remove('active');

      // Destroy Quill editor
      if (quillEditor) {
        quillEditor = null;
      }

      // Destroy map picker
      if (storytellerMapPicker) {
        storytellerMapPicker.destroy();
        storytellerMapPicker = null;
      }
    }

    function toggleStorytellerFields() {
      const category = document.getElementById('category').value;
      const storytellerFields = document.getElementById('storytellerFields');

      if (category === 'Storyteller') {
        storytellerFields.style.display = 'block';

        // Initialize map picker when storyteller fields are shown
        setTimeout(() => {
          initStorytellerMapPicker();
        }, 100);
      } else {
        storytellerFields.style.display = 'none';

        // Destroy map picker when storyteller fields are hidden
        if (storytellerMapPicker) {
          storytellerMapPicker.destroy();
          storytellerMapPicker = null;
        }
      }
    }

    function initStorytellerMapPicker() {
      // Don't reinitialize if already exists
      if (storytellerMapPicker) {
        storytellerMapPicker.refresh();
        return;
      }

      // Get current coordinates or default to Sweden center
      const latInput = document.getElementById('latitude');
      const lngInput = document.getElementById('longitude');
      const lat = parseFloat(latInput.value) || 62.0;
      const lng = parseFloat(lngInput.value) || 15.0;

      // Initialize map picker
      storytellerMapPicker = new MapPicker();
      storytellerMapPicker.init('storytellerMapPicker', lat, lng);
      storytellerMapPicker.bindInputs(latInput, lngInput);
    }

    function editStory(id) {
      currentStory = stories.find(s => s.id === id);
      if (!currentStory) return;

      document.getElementById('modalTitle').textContent = 'Edit Story';
      document.getElementById('storyId').value = currentStory.id;
      document.getElementById('title').value = currentStory.title;
      document.getElementById('slug').value = currentStory.slug;
      document.getElementById('excerpt').value = currentStory.excerpt || '';
      document.getElementById('author').value = currentStory.author || 'LIV Team';
      document.getElementById('category').value = currentStory.category || '';
      document.getElementById('displayOrder').value = currentStory.display_order || 0;

      // Toggle storyteller fields
      toggleStorytellerFields();

      // Populate storyteller fields if this is a storyteller
      if (currentStory.category === 'Storyteller') {
        document.getElementById('bio').value = currentStory.bio || '';
        document.getElementById('livContext').value = currentStory.liv_context || '';
        document.getElementById('greetingOverride').value = currentStory.greeting_override || '';

        // Set specialty topics checkboxes
        document.querySelectorAll('input[name="specialtyTopic"]').forEach(checkbox => {
          checkbox.checked = currentStory.specialty_topics?.includes(checkbox.value) || false;
        });

        // Set activity types checkboxes
        document.querySelectorAll('input[name="activityType"]').forEach(checkbox => {
          checkbox.checked = currentStory.activity_types?.includes(checkbox.value) || false;
        });

        // Set location fields
        document.getElementById('showOnMap').checked = currentStory.show_on_map || false;
        document.getElementById('latitude').value = currentStory.latitude || '';
        document.getElementById('longitude').value = currentStory.longitude || '';

        // Initialize Copy buttons for ChatGPT helper
        if (window.ChatGPTHelper) {
          const contextBtn = window.ChatGPTHelper.createCopyButton('story', currentStory.title, currentStory.bio, 'context');
          document.getElementById('livContextCopyBtn').innerHTML = '';
          document.getElementById('livContextCopyBtn').appendChild(contextBtn);

          const greetingBtn = window.ChatGPTHelper.createCopyButton('story', currentStory.title, '', 'greeting');
          document.getElementById('greetingOverrideCopyBtn').innerHTML = '';
          document.getElementById('greetingOverrideCopyBtn').appendChild(greetingBtn);
        }
      }

      // Set published date if exists
      if (currentStory.published_at) {
        const date = new Date(currentStory.published_at);
        const localDateTime = new Date(date.getTime() - date.getTimezoneOffset() * 60000)
          .toISOString()
          .slice(0, 16);
        document.getElementById('publishedAt').value = localDateTime;
      } else {
        document.getElementById('publishedAt').value = '';
      }

      // Set image
      if (currentStory.hero_image_url) {
        existingImageUrl = currentStory.hero_image_url;
        document.getElementById('heroImageUrl').value = currentStory.hero_image_url;
        document.getElementById('imagePreview').src = currentStory.hero_image_url;
        document.getElementById('uploadPlaceholder').classList.add('hidden');
        document.getElementById('imagePreviewContainer').classList.remove('hidden');
        document.getElementById('imageUploadArea').classList.add('has-image');
      }

      // Update character count
      updateCharacterCount('excerpt', 'excerptCount');

      // Open modal
      document.getElementById('storyModal').classList.add('active');

      // Initialize Quill editor with content
      setTimeout(() => {
        initQuillEditor(currentStory.content);
      }, 100);
    }

    function deleteStory(id, title) {
      deleteStoryId = id;
      document.getElementById('deleteStoryName').textContent = title;
      document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('active');
      deleteStoryId = null;
    }

    async function confirmDelete() {
      if (!deleteStoryId) return;

      try {
        await window.Supabase.db.deleteStory(deleteStoryId);
        showAlert('success', 'Story deleted successfully');
        closeDeleteModal();
        await loadStories();
      } catch (error) {
        console.error('Error deleting story:', error);
        showAlert('error', 'Failed to delete story: ' + error.message);
      }
    }

    // ==========================================
    // QUILL EDITOR
    // ==========================================
    function initQuillEditor(content = '') {
      if (quillEditor) return;

      quillEditor = new Quill('#editor', {
        theme: 'snow',
        modules: {
          toolbar: [
            [{ 'header': [2, 3, false] }],
            ['bold', 'italic', 'underline'],
            ['link', 'image'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['blockquote', 'code-block'],
            ['clean']
          ]
        },
        placeholder: 'Write your story content here...'
      });

      // Set initial content
      if (content) {
        quillEditor.root.innerHTML = content;
      }
    }

    // ==========================================
    // IMAGE UPLOAD
    // ==========================================
    function setupImageUpload() {
      const uploadArea = document.getElementById('imageUploadArea');
      const fileInput = document.getElementById('imageUpload');

      // Click to upload
      uploadArea.addEventListener('click', (e) => {
        if (e.target.classList.contains('image-remove')) return;
        fileInput.click();
      });

      // Drag and drop
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-over');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleImageFile(files[0]);
        }
      });
    }

    function handleImageSelect(event) {
      const file = event.target.files[0];
      if (file) {
        handleImageFile(file);
      }
    }

    function handleImageFile(file) {
      // Validate file type
      if (!file.type.startsWith('image/')) {
        showAlert('error', 'Please select an image file');
        return;
      }

      // Validate file size (10MB)
      if (file.size > 10 * 1024 * 1024) {
        showAlert('error', 'Image size must be less than 10MB');
        return;
      }

      currentImageFile = file;

      // Show preview
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('imagePreview').src = e.target.result;
        document.getElementById('uploadPlaceholder').classList.add('hidden');
        document.getElementById('imagePreviewContainer').classList.remove('hidden');
        document.getElementById('imageUploadArea').classList.add('has-image');
      };
      reader.readAsDataURL(file);
    }

    function removeImage() {
      currentImageFile = null;
      existingImageUrl = null;
      document.getElementById('heroImageUrl').value = '';
      document.getElementById('imageUpload').value = '';
      document.getElementById('uploadPlaceholder').classList.remove('hidden');
      document.getElementById('imagePreviewContainer').classList.add('hidden');
      document.getElementById('imageUploadArea').classList.remove('has-image');
    }

    async function uploadImage() {
      if (!currentImageFile) {
        return existingImageUrl || null;
      }

      const progressDiv = document.getElementById('uploadProgress');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');

      try {
        progressDiv.classList.add('active');
        progressFill.style.width = '0%';
        progressText.textContent = 'Uploading...';

        // Simulate progress
        const progressInterval = setInterval(() => {
          const currentWidth = parseInt(progressFill.style.width) || 0;
          if (currentWidth < 90) {
            progressFill.style.width = (currentWidth + 10) + '%';
          }
        }, 200);

        const result = await window.Supabase.storage.uploadFile(currentImageFile);

        clearInterval(progressInterval);
        progressFill.style.width = '100%';
        progressText.textContent = 'Upload complete!';

        setTimeout(() => {
          progressDiv.classList.remove('active');
        }, 1000);

        return result.url;
      } catch (error) {
        progressDiv.classList.remove('active');
        throw error;
      }
    }

    // ==========================================
    // SAVE STORY
    // ==========================================
    async function saveStory(event, asDraft = false) {
      event.preventDefault();

      const saveBtn = document.getElementById('saveBtn');
      const saveDraftBtn = document.getElementById('saveDraftBtn');
      const saveBtnText = document.getElementById('saveBtnText');
      const originalText = saveBtnText.textContent;

      try {
        // Disable buttons
        saveBtn.disabled = true;
        saveDraftBtn.disabled = true;
        saveBtnText.innerHTML = '<div class="loading"></div> Saving...';

        // Get form data
        const id = document.getElementById('storyId').value;
        const title = document.getElementById('title').value.trim();
        const slug = document.getElementById('slug').value.trim();
        const excerpt = document.getElementById('excerpt').value.trim();
        const author = document.getElementById('author').value.trim();
        const category = document.getElementById('category').value.trim();
        const displayOrder = parseInt(document.getElementById('displayOrder').value) || 0;
        const publishedAtInput = document.getElementById('publishedAt').value;

        // Get content from Quill
        const content = quillEditor ? quillEditor.root.innerHTML : '';

        // Validate
        if (!title || !slug || !excerpt) {
          showAlert('error', 'Please fill in all required fields');
          return;
        }

        if (!content || content === '<p><br></p>') {
          showAlert('error', 'Please add content to your story');
          return;
        }

        // Upload image if new one selected
        let heroImageUrl = existingImageUrl;
        if (currentImageFile) {
          heroImageUrl = await uploadImage();
        }

        // Prepare published_at
        let publishedAt = null;
        if (!asDraft) {
          if (publishedAtInput) {
            publishedAt = new Date(publishedAtInput).toISOString();
          } else {
            publishedAt = new Date().toISOString();
          }
        }

        // Collect storyteller-specific fields if category is Storyteller
        let specialtyTopics = [];
        let activityTypes = [];
        let bio = null;
        let livContext = null;
        let greetingOverride = null;
        let showOnMap = false;
        let latitude = null;
        let longitude = null;

        if (category === 'Storyteller') {
          // Get checked specialty topics
          document.querySelectorAll('input[name="specialtyTopic"]:checked').forEach(checkbox => {
            specialtyTopics.push(checkbox.value);
          });

          // Get checked activity types
          document.querySelectorAll('input[name="activityType"]:checked').forEach(checkbox => {
            activityTypes.push(checkbox.value);
          });

          bio = document.getElementById('bio').value.trim() || null;
          livContext = document.getElementById('livContext').value.trim() || null;
          greetingOverride = document.getElementById('greetingOverride').value.trim() || null;

          // Get location fields
          showOnMap = document.getElementById('showOnMap').checked;
          const latValue = document.getElementById('latitude').value.trim();
          const lngValue = document.getElementById('longitude').value.trim();
          latitude = latValue ? parseFloat(latValue) : null;
          longitude = lngValue ? parseFloat(lngValue) : null;
        }

        // Prepare data
        const storyData = {
          title,
          slug,
          excerpt,
          content,
          author,
          category: category || null,
          display_order: displayOrder,
          hero_image_url: heroImageUrl,
          published_at: publishedAt,
          specialty_topics: specialtyTopics.length > 0 ? specialtyTopics : null,
          activity_types: activityTypes.length > 0 ? activityTypes : null,
          bio: bio,
          liv_context: livContext,
          greeting_override: greetingOverride,
          show_on_map: showOnMap,
          latitude: latitude,
          longitude: longitude
        };

        // Save to database
        if (id) {
          await window.Supabase.db.updateStory(id, storyData);
          showAlert('success', asDraft ? 'Story saved as draft' : 'Story updated successfully');
        } else {
          await window.Supabase.db.createStory(storyData);
          showAlert('success', asDraft ? 'Story saved as draft' : 'Story published successfully');
        }

        // Close modal and refresh
        closeStoryModal();
        await loadStories();

      } catch (error) {
        console.error('Error saving story:', error);
        showAlert('error', 'Failed to save story: ' + error.message);
      } finally {
        saveBtn.disabled = false;
        saveDraftBtn.disabled = false;
        saveBtnText.textContent = originalText;
      }
    }

    // ==========================================
    // UTILITY FUNCTIONS
    // ==========================================
    function generateSlug(title) {
      return title
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    function updateCharacterCount(inputId, countId) {
      const input = document.getElementById(inputId);
      const counter = document.getElementById(countId);
      if (input && counter) {
        counter.textContent = input.value.length;
      }
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showAlert(type, message) {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.innerHTML = `
        <span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ'}</span>
        <span>${message}</span>
      `;

      container.appendChild(alert);

      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    function showLoading() {
      document.getElementById('loadingState').classList.remove('hidden');
      document.getElementById('tableContainer').classList.add('hidden');
      document.getElementById('emptyState').classList.add('hidden');
    }

    function showEmpty() {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('tableContainer').classList.add('hidden');
      document.getElementById('emptyState').classList.remove('hidden');
    }

    // ==========================================
    // EVENT LISTENERS
    // ==========================================
    function setupEventListeners() {
      // Logout
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          await window.Supabase.auth.signOut();
          window.location.href = 'login.html';
        });
      }

      // Search and filters
      document.getElementById('searchInput').addEventListener('input', applyFilters);
      document.getElementById('statusFilter').addEventListener('change', applyFilters);
      document.getElementById('categoryFilter').addEventListener('change', applyFilters);

      // Auto-generate slug from title
      document.getElementById('title').addEventListener('input', (e) => {
        if (!document.getElementById('storyId').value) {
          document.getElementById('slug').value = generateSlug(e.target.value);
        }
      });

      // Character counter
      document.getElementById('excerpt').addEventListener('input', () => {
        updateCharacterCount('excerpt', 'excerptCount');
      });

      // Image upload
      setupImageUpload();

      // Close modal on outside click
      document.getElementById('storyModal').addEventListener('click', (e) => {
        if (e.target.id === 'storyModal') {
          closeStoryModal();
        }
      });

      document.getElementById('deleteModal').addEventListener('click', (e) => {
        if (e.target.id === 'deleteModal') {
          closeDeleteModal();
        }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeStoryModal();
          closeDeleteModal();
        }
      });
    }

    // ==========================================
    // START APPLICATION
    // ==========================================
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

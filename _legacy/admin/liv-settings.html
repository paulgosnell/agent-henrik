<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="../">
    <title>LIV Settings - Luxury Travel Sweden CMS</title>
    <link rel="stylesheet" href="admin/admin.css">

    <!-- Component Loader -->
    <script src="admin/admin-component-loader.js?v=3"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .category-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .category-filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--admin-border);
            background: var(--admin-surface);
            color: var(--admin-text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .category-filter-btn:hover {
            background: var(--admin-surface-elevated);
        }

        .category-filter-btn.active {
            background: var(--admin-accent);
            color: white;
            border-color: var(--admin-accent);
        }

        .instruction-card {
            background: var(--admin-surface);
            border: 1px solid var(--admin-border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
        }

        .instruction-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .instruction-title-group {
            flex: 1;
        }

        .instruction-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--admin-text);
            margin: 0 0 4px 0;
        }

        .instruction-meta {
            display: flex;
            gap: 12px;
            align-items: center;
            font-size: 13px;
            color: var(--admin-text-secondary);
        }

        .category-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .category-badge.promote { background: #e8f5e9; color: #2e7d32; }
        .category-badge.avoid { background: #ffebee; color: #c62828; }
        .category-badge.knowledge { background: #e3f2fd; color: #1565c0; }
        .category-badge.tone { background: #f3e5f5; color: #6a1b9a; }
        .category-badge.general { background: #f5f5f5; color: #616161; }

        .priority-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--admin-surface-elevated);
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .instruction-content {
            color: var(--admin-text);
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .instruction-actions {
            display: flex;
            gap: 8px;
        }

        .toggle-active {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--admin-text-secondary);
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--admin-border);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--admin-accent);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        .form-textarea {
            min-height: 120px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--admin-text-secondary);
        }

        .empty-state-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            opacity: 0.3;
        }

        .priority-input {
            width: 100px;
        }

        .help-text {
            background: var(--admin-surface-elevated);
            border-left: 3px solid var(--admin-accent);
            padding: 16px;
            margin-bottom: 24px;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--admin-text-secondary);
        }

        .help-text strong {
            color: var(--admin-text);
            display: block;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <p>Loading LIV settings...</p>
    </div>

    <!-- Main Container -->
    <div id="adminApp" class="admin-container" style="display: none;">
        <!-- Sidebar Navigation - Loaded from component -->

        <div id="sidebar-placeholder"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="content-header">
                <div class="header-left">
                    <h1>LIV AI Settings</h1>
                    <p class="subtitle">Control what LIV says and how LIV responds to visitors</p>
                </div>
                <div class="header-right">
                    <button id="addInstructionBtn" class="btn-primary">
                        <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                            <path d="M10 4V16M4 10H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Add Instruction
                    </button>
                </div>
            </header>

            <!-- Help Text -->
            <div class="help-text">
                <strong>How LIV Instructions Work</strong>
                These instructions are dynamically injected into LIV's system prompt when responding to visitors. Use them to guide LIV's behavior, promote specific offerings, avoid certain topics, or provide specialized knowledge. Active instructions with higher priority values appear first in the prompt.
            </div>

            <!-- Global CTA Contexts Section -->
            <div class="content-section" style="margin-bottom: 32px;">
                <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: var(--admin-text);">Global CTA Contexts</h2>
                <p style="color: var(--admin-text-secondary); margin-bottom: 20px; font-size: 14px;">
                    Customize LIV's behavior for the Hero button and floating LIV button that appear across all pages.
                </p>
                <div id="globalContextsList" style="display: grid; gap: 16px;">
                    <div class="overview-loading">
                        <div class="skeleton-loader"></div>
                        <div class="skeleton-loader"></div>
                    </div>
                </div>
            </div>

            <!-- Corporate Experiences Section -->
            <div class="content-section" style="margin-bottom: 32px;">
                <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: var(--admin-text);">Corporate Experiences</h2>
                <p style="color: var(--admin-text-secondary); margin-bottom: 20px; font-size: 14px;">
                    Add context for each corporate offering (group sizes, duration, pricing, venues).
                </p>
                <div id="corporateExperiencesList" style="display: grid; gap: 16px;">
                    <div class="overview-loading">
                        <div class="skeleton-loader"></div>
                        <div class="skeleton-loader"></div>
                    </div>
                </div>
            </div>

            <!-- Divider -->
            <div style="border-top: 2px solid var(--admin-border); margin: 40px 0;"></div>

            <!-- Admin Instructions Section -->
            <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: var(--admin-text);">Admin Instructions</h2>
            <p style="color: var(--admin-text-secondary); margin-bottom: 20px; font-size: 14px;">
                Global instructions that control LIV's overall behavior across all conversations.
            </p>

            <!-- Category Filter -->
            <div class="category-filter">
                <button class="category-filter-btn active" data-category="all">All</button>
                <button class="category-filter-btn" data-category="promote">Promote</button>
                <button class="category-filter-btn" data-category="avoid">Avoid</button>
                <button class="category-filter-btn" data-category="knowledge">Knowledge</button>
                <button class="category-filter-btn" data-category="tone">Tone</button>
                <button class="category-filter-btn" data-category="general">General</button>
            </div>

            <!-- Instructions List -->
            <div id="instructionsList" class="instructions-container">
                <div class="overview-loading">
                    <div class="skeleton-loader"></div>
                    <div class="skeleton-loader"></div>
                    <div class="skeleton-loader"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div id="instructionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Instruction</h2>
                <button class="modal-close" onclick="closeInstructionModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <form id="instructionForm" class="modal-form">
                <input type="hidden" id="instructionId">

                <div class="form-group">
                    <label for="instructionTitle">Title</label>
                    <input type="text" id="instructionTitle" class="form-input" required placeholder="e.g., Promote Northern Lights Tours">
                </div>

                <div class="form-group">
                    <label for="instructionCategory">Category</label>
                    <select id="instructionCategory" required>
                        <option value="">Select category...</option>
                        <option value="promote">Promote - Things to highlight and recommend</option>
                        <option value="avoid">Avoid - Things not to mention or discuss</option>
                        <option value="knowledge">Knowledge - Facts and information LIV should know</option>
                        <option value="tone">Tone - How LIV should communicate</option>
                        <option value="general">General - Other instructions</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="instructionMode">LIV Mode</label>
                    <select id="instructionMode" required>
                        <option value="regular">Regular (Itinerary Planning) - For destination & experience journeys</option>
                        <option value="storyteller">Storyteller (Discovery) - For storyteller connections only</option>
                        <option value="both">Both - Applies to all LIV conversations</option>
                    </select>
                    <small style="color: var(--admin-text-secondary); font-size: 13px; margin-top: 4px; display: block;">
                        Choose which LIV mode this instruction applies to. "Regular" for travel itineraries, "Storyteller" for meeting creatives.
                    </small>
                </div>

                <div class="form-group">
                    <label for="instructionText">Instruction</label>
                    <textarea id="instructionText" class="form-textarea" required placeholder="Write the instruction that will be given to LIV..."></textarea>
                    <small style="color: var(--admin-text-secondary); font-size: 13px; margin-top: 4px; display: block;">
                        Be specific and clear. This text will be injected directly into LIV's system prompt.
                    </small>
                </div>

                <div class="form-group">
                    <label for="instructionPriority">Priority (0-100)</label>
                    <input type="number" id="instructionPriority" class="form-input priority-input" value="50" min="0" max="100">
                    <small style="color: var(--admin-text-secondary); font-size: 13px; margin-top: 4px; display: block;">
                        Higher numbers appear first in LIV's prompt. Use 80+ for critical instructions.
                    </small>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="instructionActive" checked>
                        <span>Active (instruction is currently in use)</span>
                    </label>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeInstructionModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Instruction</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="supabase-client.js?v=2"></script>
    <script src="admin/auth.js"></script>
    <script src="chatgpt-helper.js"></script>
    <script src="liv-settings.js"></script>

    <!-- Auth Protection -->
    <script>
        (async function() {
            const user = await window.AuthManager.requireAuth();
            if (user) {
                await window.AuthManager.updateUserInfoUI();
            }
        })();
    </script>
</body>
</html>
